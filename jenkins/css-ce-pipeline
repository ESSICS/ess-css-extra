#!groovyâ€‹
import java.io.*

pipeline {
  /*
   * Agent sets up which environment that the pipeline will execute inside.
   * Can be specified to label of certain slave set up a docker container
   */
  agent {
    node {
      label 'css'
    }
  }

  /*
   * Environment sets up a map containing key : value pairs
   */
  environment {
    buildPath = '.'
    sourceRepo = 'https://github.com/ControlSystemStudio/'
    mvnXML = 'settings-for-jenkins-ca.xml'
    branchext = 'master'
    email = 'claudio.rosati@esss.se'
    MVNOPT="-e -B -P ess-css-settings,platform-default,csstudio-composite-repo-enable,eclipse-sites"
  }

  options {
    disableConcurrentBuilds() //Disallow concurrent executions of the Pipeline
    timeout(time:4, unit: 'HOURS') //Set a timeout period for the Pipeline run, after which Jenkins should abort the Pipeline
    timestamps()

  }
  triggers { cron('H 3-7 * * *') }

  stages {

    stage('BuildAll') {
      steps {
        echo "hello ${env.WORKSPACE}"
          echo "branch name = ${env.BRANCH_NAME}"
        sh '''ls .
        java -version
        export MAVEN_OPTS="-Xmx2048m -Xms1024M -Xss128M -XX:-UseGCOverheadLimit"'''
      }
    }
    stage('workspace-prep 00000'){
         steps{
          sh script: "if [[ -d /${env.WORKSPACE}/${env.buildPath} ]]; then rm -fr /${env.WORKSPACE}/${env.buildPath}/*;rm -fr /${env.WORKSPACE}/${env.buildPath}/.git;rm -rf /${env.WORKSPACE}/${env.buildPath}/.m2/p2/osgi/bundle/org.csstudio.*;rm -rf /${env.WORKSPACE}/${env.buildPath}/.m2/p2/osgi/bundle/org.diirt.*;else mkdir -pv /${env.WORKSPACE}/${env.buildPath};fi", returnStdout: true
          //alternative = nuke with deletedir step and then create new
         }
    }
    stage('clone css-extra 00100'){
       steps {
          dir("ess-css-extra"){
            git(url: 'https://github.com/fjubben/ess-css-extra', branch: 'jespertest')
          }
       }
     }
     stage('maven-osgi-bundle'){
        steps {
            dir("maven-osgi-bundle"){
              git(url: 'https://github.com/ControlSystemStudio/maven-osgi-bundles.git', branch: 'master')
              sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
            }
        }
     }
     stage('CS-Studio CE 00300 - cs-studio-thirdparty'){
        steps{
          dir("cs-studio-thirdparty"){
            git(url: 'https://github.com/ControlSystemStudio/cs-studio-thirdparty.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
     stage('CS-Studio CE 00400 - diirt'){
        steps{
          dir("diirt"){
            git(url: 'https://github.com/ControlSystemStudio/diirt.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
     stage('CS-Studio CE 00500 - cs-studio'){
     steps{
          dir("cs-studio"){
            git(url: 'https://github.com/ControlSystemStudio/cs-studio.git', branch: 'master')
            sh "cd core; mvn ${env.MVNOPT} --settings ../../ess-css-extra/maven/${mvnXML} clean verify"
            sh "cd application; mvn ${env.MVNOPT} --settings ../../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }

     stage('CS-Studio CE 00550 - org.csstudio.display.builder'){
        steps{
          dir("org.csstudio.display.builder"){
            git(url: 'https://github.com/kasemir/org.csstudio.display.builder.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} -Dcss_repo=file:${env.WORKSPACE}/${env.buildPath}/ess-css-extra/ess_css_comp_repo clean verify".stripIndent()
          }
        }
     }
     stage('CS-Studio CE 00600 - org.csstudio.product'){
        steps{
          dir("org.csstudio.product"){
            git(url: 'https://github.com/kasemir/org.csstudio.product.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
     stage('CS-Studio CE 00700 - org.csstudio.ess.product'){
        steps{
          dir("org.csstudio.ess.product"){
            git(url: 'https://github.com/ControlSystemStudio/org.csstudio.ess.product.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }

  }



}
