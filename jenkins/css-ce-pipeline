#!groovyâ€‹
import java.io.*

pipeline {

  /*
   * Agent sets up which environment that the pipeline will execute inside.
   * Can be specified to label of certain slave set up a docker container
   */
  agent {
    node {
      label 'css'
    }
  }

  /*
   * Environment sets up a map containing key : value pairs
   */
  environment {
    buildPath = 'Original-CS-Studio'
    sourceRepo = 'https://github.com/ControlSystemStudio/'
    branchext = 'master'
    email = 'claudio.rosati@esss.se'
    pass1 = 'it works'
    core = load "groovyfile"
  }

  options {
    disableConcurrentBuilds() //Disallow concurrent executions of the Pipeline
    timeout(time:4, unit: 'HOURS') //Set a timeout period for the Pipeline run, after which Jenkins should abort the Pipeline
    timestamps()

  }
  triggers { cron('H 3-7 * * *') }
  stages {
    stage('BuildAll') {
      steps {
        echo "hello ${env.WORKSPACE}"
        sh 'ls .'
        echo "branch name = ${env.BRANCH_NAME}"
        sh 'java -version'


      }
    }
    stage('workspace-prep 00000'){
         steps{
          sh "if [[ -d /${env.WORKSPACE}/${env.buildPath} ]]; then rm -fr /${env.WORKSPACE}/${env.buildPath}/*; rm -fr /${env.WORKSPACE}/${env.buildPath}/.git; rm -rf /${env.WORKSPACE}/${env.buildPath}/.m2/p2/osgi/bundle/org.csstudio.*;rm -rf /${env.WORKSPACE}/${env.buildPath}/.m2/p2/osgi/bundle/org.diirt.*; else mkdir -pv /${env.WORKSPACE}/${env.buildPath};fi"
         }
    }
    stage('clone css-extra 00100'){
       steps {
          dir("ess-css-extra"){
            git(url: 'https://github.com/fjubben/ess-css-extra', branch: 'jespertest')
          }
       }
     }
     stage('maven-osgi-bundle'){
        steps {
            dir("maven-osgi-bundle"){
              git(url: 'https://github.com/ControlSystemStudio/maven-osgi-bundles.git', branch: 'master')
            }
            sh export MAVEN_OPTS='-Xmx2048m -Xms1024M -Xss128M'
            sh export MVNOPT="-B -P ess-css-settings,platform-default,csstudio-composite-repo-enable,eclipse-sites"
            sh "cd maven-osgi-bundles; mvn $MVNOPT --settings ../ess-css-extra/maven/settings-for-jenkins-original.xml clean verify"

        }
     }
  }



}
