#!groovyâ€‹
import java.io.*

pipeline {
  /*
   * Environment sets up a map containing key : value pairs
   * The variables will be exported to the shell jenkins uses to execute in
   *
   */
  environment {
    buildPath = 'css-ce'
    sourceRepo = 'https://github.com/ControlSystemStudio'
    mvnXML = 'settings-for-jenkins-ce.xml'
    branch = 'master'
    MAVEN_OPTS="-Xmx2048m -Xms1024M -Xss128M -XX:-UseGCOverheadLimit"
    email = 'claudio.rosati@esss.se'
    MVNOPT="-e -X -B -P ess-css-settings,platform-default,csstudio-composite-repo-enable,eclipse-sites"
  }
  /*
   * Agent sets up which environment that the pipeline will execute inside.
   * Can be specified to label of certain slave set up a docker container
   */
  agent {
    node {
      label 'css'
    }
  }


  options {
  disableConcurrentBuilds() //Disallow concurrent executions of the Pipeline
    timeout(time:4, unit: 'HOURS') //Set a timeout period for the Pipeline run, after which Jenkins should abort the Pipeline
    timestamps()

  }

  stages {
    stage('workspace-prep 00000, clean up'){
         steps{
           echo "buildPath = ${env.buildPath} \n sourceRepo = ${env.sourceRepo}"
           echo "mvnXML = ${env.mvnXML}"
           echo "branch = ${env.branch}"
           echo "email = ${env.email}"
           echo "MVNOPT=${env.MVNOPT}"
           echo "${env.NODE_NAME}"
           echo "${env.WORKSPACE}"
           sh "export"
           pwd()
           deleteDir()
         }

    }
    stage('clone css-extra 00100'){
       steps {
          dir("${buildPath}/ess-css-extra"){
            pwd()
            git(url: 'https://github.com/fjubben/ess-css-extra', branch: 'jespertest')
          }
       }
     }
     stage('maven-osgi-bundles'){
        steps {
            dir("${buildPath}/maven-osgi-bundles"){
              git(url: "${sourceRepo}/maven-osgi-bundles.git", branch: 'master')
              pwd()
              sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
            }
        }
     }
     stage('CS-Studio CE 00300 - cs-studio-thirdparty'){
        steps{
          dir("${buildPath}/cs-studio-thirdparty"){
            git(url: "${sourceRepo}/cs-studio-thirdparty.git", branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
     stage('CS-Studio CE 00400 - diirt'){
        steps{
          dir("${buildPath}/diirt"){
            git(url: "${sourceRepo}/diirt", branch: 'master')
            //git(url: "https://github.com/diirt/diirt", branch: 'master')
            script {
              try {
                sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
              }catch(InterruptedException e){
                assert false
              }
            }

          }
        }
     }
     stage('CS-Studio CE 00500 - cs-studio'){
      steps{
          dir("${buildPath}/cs-studio"){
            git(url: "${sourceRepo}/cs-studio", branch: 'master')
            sh "cd core; mvn ${env.MVNOPT} --settings ../../ess-css-extra/maven/${mvnXML} clean verify"
            sh "cd application; mvn ${env.MVNOPT} --settings ../../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }

     stage('CS-Studio CE 00550 - org.csstudio.display.builder'){
        steps{
          dir("${buildPath}/org.csstudio.display.builder"){
            git(url: 'https://github.com/kasemir/org.csstudio.display.builder.git', branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} -Dcss_repo=file:${env.WORKSPACE}/../${env.buildPath}/ess-css-extra/ess_css_comp_repo clean verify".stripIndent()
          }
        }
     }
     stage('CS-Studio CE 00600 - org.csstudio.product'){
        steps{
          dir("${buildPath}/org.csstudio.product"){
            git(url: "${sourceRepo}/org.csstudio.product.git", branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
     stage('CS-Studio CE 00700 - org.csstudio.ess.product'){
        steps{
          dir("org.csstudio.ess.product"){
            git(url: "${sourceRepo}/org.csstudio.ess.product.git", branch: 'master')
            sh "mvn ${env.MVNOPT} --settings ../ess-css-extra/maven/${mvnXML} clean verify"
          }
        }
     }
  }
}
